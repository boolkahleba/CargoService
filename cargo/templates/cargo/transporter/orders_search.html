{% extends 'cargo/base.html' %}
{% load crispy_forms_tags %}

{% block title %}Поиск заказов - CargoService{% endblock %}

{% block extra_css %}
    <style>
        .order-card {
            border-left: 4px solid #dee2e6;
            transition: all 0.3s;
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .order-card.matched {
            border-left-color: #198754;
        }

        .order-card.not-matched {
            border-left-color: #dc3545;
            opacity: 0.7;
        }

        .match-badge {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .vehicle-match {
            background-color: #e8f4f1;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .search-sidebar {
            position: sticky;
            top: 20px;
        }

        .map-preview {
            height: 210px;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            margin: 10px 0;
        }

    </style>
{% endblock %}

{% block content %}
    <div class="row">
        <!-- Левая колонка - Фильтры -->
        <div class="col-lg-4">
            <div class="card shadow mb-4 search-sidebar">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-funnel"></i> Фильтры поиска</h5>
                </div>
                <div class="card-body">
                    <form method="get" id="searchForm">
                        {{ form|crispy }}

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Найти заказы
                            </button>
                            <a href="{% url 'transporter_orders_search' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Сбросить фильтры
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Правая колонка - Результаты -->
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>
                    <i class="bi bi-search text-primary"></i> Поиск заказов
                </h1>
                <div class="text-end">
                    {% if search_performed %}
                        <span class="badge bg-info fs-6">Найдено: {{ total_found }}</span>
                    {% endif %}
                </div>
            </div>

            <!-- Статистика -->
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-1">Доступных заказов</h6>
                                    <h4 class="mb-0">{{ total_found }}</h4>
                                </div>
                                <div class="text-primary">
                                    <i class="bi bi-box-seam display-6"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-1">Ваш транспорт</h6>
                                    <h4 class="mb-0">{{ available_vehicles.count }}</h4>
                                </div>
                                <div class="text-success">
                                    <i class="bi bi-truck display-6"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Результаты поиска -->
            {% if orders %}
                {% for order in orders %}
                    <div class="card order-card mb-3 {% if order.is_matched %}matched{% else %}not-matched{% endif %}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title mb-1">
                                        Заказ #{{ order.id }}
                                        {% if order.is_matched %}
                                            <span class="match-badge bg-success text-white">
                                    <i class="bi bi-check-circle"></i> Подходит
                                </span>
                                        {% else %}
                                            <span class="match-badge bg-danger text-white">
                                    <i class="bi bi-x-circle"></i> Не подходит
                                </span>
                                        {% endif %}
                                    </h5>
                                    <p class="text-muted mb-2">
                                        <i class="bi bi-calendar"></i> Создан: {{ order.date_create|date:"d.m.Y H:i" }}
                                    </p>
                                </div>
                                <div class="text-end">
                                    <h4 class="text-success mb-0">{{ order.coast }} ₽</h4>
                                    <small class="text-muted">Стоимость доставки</small>
                                </div>
                            </div>

                            <!-- Маршрут -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body py-2">
                                            <h6 class="mb-1">
                                                <i class="bi bi-geo-alt-fill text-success"></i> Отправление
                                            </h6>
                                            <p class="mb-0">{{ order.address_departure }}</p>
                                            <small class="text-muted">
                                                {{ order.date_departure_plan|date:"d.m.Y H:i" }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body py-2">
                                            <h6 class="mb-1">
                                                <i class="bi bi-geo-alt-fill text-danger"></i> Назначение
                                            </h6>
                                            <p class="mb-0">{{ order.address_arrival }}</p>
                                            <small class="text-muted">
                                                {{ order.date_arrival_plan|date:"d.m.Y H:i" }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Характеристики груза -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="text-muted small">Вес</div>
                                        <div class="h5 mb-0">{{ order.weight|floatformat:1 }} кг</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="text-muted small">Габариты</div>
                                        <div class="h6 mb-0">{{ order.length|floatformat:1 }}×{{ order.width|floatformat:1 }}×{{ order.height|floatformat:1 }}
                                            м
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="text-muted small">Отправитель</div>
                                        <div class="h6 mb-0">{{ order.sender.name|default:"Не указан" }}</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="text-muted small">Рейтинг</div>
                                        <div class="h6 mb-0">
                                            {% if order.sender.user.transporter_profile.score %}
                                                {{ order.sender.user.transporter_profile.score|floatformat:1 }}/5.0
                                            {% else %}
                                                Нет оценок
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Предпросмотр карты -->
                            <div id="mapPreview{{ order.id }}" class="map-preview">
                                <!-- Карта будет здесь -->
                            </div>

                            <!-- Информация о совместимости -->
                            {% if order.is_matched and order.suitable_vehicles %}
                                <div class="vehicle-match">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1 text-success">
                                                <i class="bi bi-check-circle"></i> Совместим с вашим транспортом
                                            </h6>
                                            <p class="small mb-0">
                                                Подходит {{ order.suitable_vehicles|length }}
                                                из {{ available_vehicles.count }} ТС
                                            </p>
                                        </div>
                                        <div>
                                            <form method="post" action="{% url 'transporter_accept_order' order.id %}">
                                                {% csrf_token %}
                                                <select name="vehicle_id"
                                                        class="form-select form-select-sm d-inline-block w-auto me-2">
                                                    {% for vehicle in order.suitable_vehicles %}
                                                        <option value="{{ vehicle.id }}">
                                                            {{ vehicle.get_type_display }} ({{ vehicle.capacity }} кг)
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                                <button type="submit" class="btn btn-success btn-sm">
                                                    <i class="bi bi-check-lg"></i> Взять заказ
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            {% elif not order.is_matched and available_vehicles.exists %}
                                <div class="alert alert-warning mb-0">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    Груз не подходит под параметры вашего транспорта.
                                </div>
                            {% endif %}

                            <!-- Дополнительные действия -->
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div>
                                    <button class="btn btn-outline-info btn-sm" data-bs-toggle="modal"
                                            data-bs-target="#detailsModal{{ order.id }}">
                                        <i class="bi bi-info-circle"></i> Подробнее
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal"
                                            data-bs-target="#contactModal{{ order.id }}">
                                        <i class="bi bi-telephone"></i> Контакты
                                    </button>
                                </div>
                                {% if not order.is_matched %}
                                    <div>
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle"></i>
                                            Добавьте подходящий транспорт для этого заказа
                                        </small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Модальное окно деталей -->
                    <div class="modal fade" id="detailsModal{{ order.id }}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">Детали заказа #{{ order.id }}</h5>
                                    <button type="button" class="btn-close btn-close-white"
                                            data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <th>Вес:</th>
                                            <td>{{ order.weight|floatformat:1 }} кг</td>
                                        </tr>
                                        <tr>
                                            <th>Габариты:</th>
                                            <td>{{ order.length|floatformat:1 }}×{{ order.width|floatformat:1 }}×{{ order.height|floatformat:1 }}
                                                м
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Объем:</th>
                                            <td>{{ order.volume|floatformat:2 }} м³</td>
                                        </tr>
                                        <tr>
                                            <th>Тип груза:</th>
                                            <td>Общий груз</td>
                                        </tr>
                                        <tr>
                                            <th>Особые условия:</th>
                                            <td>{% if order.comment %}{{ order.comment }}{% else %}Нет{% endif %}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Модальное окно контактов -->
                    <div class="modal fade" id="contactModal{{ order.id }}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-info text-white">
                                    <h5 class="modal-title">Контакты отправителя</h5>
                                    <button type="button" class="btn-close btn-close-white"
                                            data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="text-center mb-3">
                                        <i class="bi bi-person-circle display-4 text-muted"></i>
                                        <h5 class="mt-2">{{ order.sender.name|default:"Не указано" }}</h5>
                                    </div>
                                    <table class="table table-sm">
                                        <tr>
                                            <th><i class="bi bi-telephone"></i> Телефон:</th>
                                            <td>{{ order.sender.user.phone|default:"Не указан" }}</td>
                                        </tr>
                                        <tr>
                                            <th><i class="bi bi-envelope"></i> Email:</th>
                                            <td>{{ order.sender.user.email|default:"Не указан" }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}

                <!-- Пагинация -->
                {% if orders.has_other_pages %}
                    <nav aria-label="Навигация по страницам" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if orders.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1


                                            {% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        <i class="bi bi-chevron-double-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page=


                                            {{ orders.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                </li>
                            {% endif %}

                            {% for num in orders.paginator.page_range %}
                                {% if orders.number == num %}
                                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                {% elif num > orders.number|add:'-3' and num < orders.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page=


                                                {{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if orders.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=


                                            {{ orders.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page=


                                            {{ orders.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        <i class="bi bi-chevron-double-right"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}

            {% else %}
                <div class="text-center py-5">
                    {% if search_performed %}
                        <i class="bi bi-search display-1 text-muted"></i>
                        <h4 class="mt-4">Заказы не найдены</h4>
                        <p class="text-muted">Попробуйте изменить параметры поиска</p>
                        <a href="{% url 'transporter_orders_search' %}" class="btn btn-primary mt-3">
                            <i class="bi bi-arrow-clockwise"></i> Сбросить фильтры
                        </a>
                    {% else %}
                        <i class="bi bi-search display-1 text-muted"></i>
                        <h4 class="mt-4">Найдите подходящие заказы</h4>
                        <p class="text-muted">Используйте фильтры слева для поиска заказов</p>
                        {% if not available_vehicles.exists %}
                            <div class="alert alert-warning mt-3">
                                <i class="bi bi-exclamation-triangle"></i>
                                У вас нет добавленного транспорта. Добавьте транспорт для поиска заказов.
                                <div class="mt-2">
                                    <a href="{% url 'transporter_vehicle_add' %}" class="btn btn-warning btn-sm">
                                        <i class="bi bi-plus-circle"></i> Добавить транспорт
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}
{% block extra_js %}
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey={{ YANDEX_MAPS_API_KEY }}"
            type="text/javascript"></script>
    <script>
        // Данные из Django
        const ordersData = {{ orders_data_json|safe }};

        // Функция инициализации карты для одного заказа
        function initOrderMap(orderId, latDep, lonDep, latArr, lonArr) {
            ymaps.ready(function () {
                var map = new ymaps.Map(`mapPreview${orderId}`, {
                    center: [latDep, lonDep],
                    zoom: 9,
                    controls: ['zoomControl']
                });

                // Создаем маршрут
                var multiRoute = new ymaps.multiRouter.MultiRoute({
                    referencePoints: [
                        [latDep, lonDep],
                        [latArr, lonArr]
                    ],
                    params: {
                        routingMode: 'auto'
                    }
                }, {
                    boundsAutoApply: true // Автоматически подогнать карту под маршрут
                });

                map.geoObjects.add(multiRoute);
            });
        }

        // Инициализируем карты после загрузки страницы
        document.addEventListener('DOMContentLoaded', function () {
            ordersData.forEach(function (order) {
                if (order.lat_dep && order.lon_dep && order.lat_arr && order.lon_arr) {
                    initOrderMap(order.id, order.lat_dep, order.lon_dep, order.lat_arr, order.lon_arr);
                }
            });
        });
    </script>
{% endblock %}